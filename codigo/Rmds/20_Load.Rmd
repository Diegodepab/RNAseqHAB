
## Reading file(s)

If `DATA_FILES` contains only one file, this is the table con convert in object. 
But when several files are given in `DATA_FILES`, another [edgeR][] [@Robinson2010bis] function is used to load files and construct the `DEGlist` object. Look at function `LoadExpressionData()`.

```{r buildx}
# use 'x' as a short name since it will be thoroughly used
x <- LoadExpressionData(DATA_FILES, DATA_DIR, EXP_FACTORS, COLUMNS_TO_READ, OTHER_DATA)

# borrar constantes que ya no se necesitan
rm(DATA_FILES, COLUMNS_TO_READ, OTHER_DATA)
```

## Assigning colours to factors

A partir de los factores experimentales definidos en `EXP_FACTORS`, vamos a determinar cuántos factores diferentes hay (por si hay más de dos) y con ellos vamos a definir un color característico que se utilizará en las representaciones.

```{r FactorsColours}
# convert experimental factors in colours
UNIQ_FACTORS <- unique(EXP_FACTORS)
EXP_COLORS <- as.vector(EXP_FACTORS)
i <- 1
for (i in 1:length(UNIQ_FACTORS)) {
   # replace each factor by a colour number
   EXP_COLORS <- replace(EXP_COLORS, EXP_COLORS == UNIQ_FACTORS[i], i + 1)
}
```

**Data summary**:

Property   | Value
:--------- | :------
Genes      | `r dim(x)[1]`
Samples (conditions) | `r dim(x)[2]`
Unique factors       | `r toString(UNIQ_FACTORS)`
Colours              | `r toString(unique(EXP_COLORS))`


## Library sizes and MDS plots {#origSizeMDS}

Let's plot the raw library sizes to see if they are equilibrated, and a multi-dimensional scaling ([MDS]) scatterplot of distances between the samples using the `plotMDS()`function, as well as pincipal component analysis ([PCA]) plot with the user-defnde function `PlotMyPCA(`, to show the relative similarities of the raw samples.

[START EXPANDIBLE]: #
`r EXPAND_bx` 
Expand to read about <b>library size, MDS and PCA plots</b></summary>

* Raw library sizes to see if they are balanced. 
`r NOTE_bx` Ideally, library sizes must be similar in all samples to avoid bias in type I error rate and FDR (_false discovery rate_, the type II error rate). Methods better supporting unequal library sizes are `voom()` and `glm()` broth from `limma` [@Law2014tt]. They will be used for differential expression in this script.
* _Multidimensional scaling_ (**[MDS]**) scatterplot of distances between the samples to reduce de dimensionality to two dimensions in an iterative process to show the sample relative similarities. Replicates are expected to form clusters, that is, [the distance between replicates is shorter than with other samples](https://richardlent.github.io/post/multivariate-analysis-with-r/#multidimensional-scaling).
* _Principal components analysis_ (**[PCA]**) [@Jolliffe2016dp] of correlation or covariance values based on the user-defined function `PlotMyPCA()`. It is an easy and fast way to analyse data by a dimensional reduction of multivariate data. Replicates should be correlate, so they are expected to form clusters when uncorrelated (principal components: PC) are used. The [PCs are linear combinations of the original variables that maximise the dispersion of samples](https://richardlent.github.io/post/multivariate-analysis-with-r/#principal-components-analysis).

</details> 
[END EXPANDIBLE]: #


```{r sizesMDSplots, fig.width=6, fig.height=5, out.width=c('33%', '33%', '33%'), fig.show='hold'} 
# grasp the names of samples to pinpoint them
COL_NAMES <- colnames(x)

# plot library sizes
barplot(x$samples$lib.size * 1e-6, 
        names = COL_NAMES, 
        col = EXP_COLORS,
        ylab = "Library size (millions)", 
        las = 2, 
        main = "Library sizes of raw (original) data") 

# multi-dimensional scaling scatterplot
plotMDS(x, 
        col = EXP_COLORS, 
        main = "Relative similarities of raw samples")

# to indicate the correspondence of colours and factors in both plots
legend("topleft", legend = as.vector(UNIQ_FACTORS), fill = unique(EXP_COLORS))

# PCA, where pca_sum will retain all parameters from the analysis
pca_sum <- PlotMyPCA(x$counts, "PCA of raw data", thisScale = FALSE)
```


## Save raw counts 

Raw counts are saved as _tab separated values_ (**.tsv**) file, where rows are gene codes and columns are experimental data. The user-defined function `SaveTSV()` will be used from now on to save data.


```{r datatable}
fileName <- SaveTSV(x$counts, "rawData-")
message("Raw counts table for all genes was saved in file", "\n", fileName)
```
